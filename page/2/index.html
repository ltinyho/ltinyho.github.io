<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/manifest.json">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.ltinyho.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"517HTSWU9U","apiKey":"6996019cc0eab1d5c8a63c8b69d9ec67","indexName":"blog","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="ltinyho&#39;s Blog">
<meta property="og:url" content="http://blog.ltinyho.top/page/2/index.html">
<meta property="og:site_name" content="ltinyho&#39;s Blog">
<meta property="og:locale">
<meta property="article:author" content="ltinyho">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.ltinyho.top/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>ltinyho's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ltinyho's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/ltinyho" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.ltinyho.top/2021/08/20/go-time-rate-limit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ltinyho">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ltinyho's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/20/go-time-rate-limit/" class="post-title-link" itemprop="url">go 令牌桶 time/rate 实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-08-20 09:05:00" itemprop="dateCreated datePublished" datetime="2021-08-20T09:05:00+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-09-02 09:45:09" itemprop="dateModified" datetime="2023-09-02T09:45:09+08:00">2023-09-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在微服务中,为了防止在高并发场景下被大流量冲击,保护下游服务,防止服务过载,需要有控制并发请求数的手段. 限流器常用的算法有令牌桶&#x2F;漏桶算法&#x2F;自适应限流. golang 标准库中自带的限流算法的实现,基于令牌桶算法 <a target="_blank" rel="noopener" href="https://github.com/golang/time/blob/master/rate/rate.go">rate</a>.</p>
<p>令牌桶可以想象成往一个固定容量大小的桶中放 Token(可以理解成门票),系统会以固定速率往桶中放 Token,桶满了则不放.用户从桶中去 Token,如果有 Token(门票)则可以一直取. 如果没有 Token(门票)则需要等待系统发放. 令牌桶在一段时间的总 Token(门票)数是固定的,但峰值数量可以达到桶的容量.</p>
<h1 id="golang-time-rate-的使用"><a href="#golang-time-rate-的使用" class="headerlink" title="golang time rate 的使用"></a>golang time rate 的使用</h1><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一个参数 r 代表每秒放入的令牌数</span></span><br><span class="line"><span class="comment">// 第二个参数 b 代表桶的大小</span></span><br><span class="line"><span class="comment">// 以下表示桶的大小为 1,每秒放入10个令牌,那么放入令牌的间隔是 0.1s</span></span><br><span class="line">limiter := NewLimiter(<span class="number">10</span>,<span class="number">1</span>)</span><br><span class="line">	</span><br><span class="line"><span class="comment">// 也可以使用另一种方法初始化,跟上面的含义一致</span></span><br><span class="line">	</span><br><span class="line">limit := Every(<span class="number">100</span> * time.Millisecond) <span class="comment">// 每 100 ms生成一个token</span></span><br><span class="line"></span><br><span class="line">limiter := NewLimiter(limit, <span class="number">1</span>) <span class="comment">// 也是每秒放入10个令牌</span></span><br></pre></td></tr></table></figure>
<h2 id="获取-Token-方法"><a href="#获取-Token-方法" class="headerlink" title="获取 Token 方法"></a>获取 Token 方法</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WaitN/Wait</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lim *Limiter)</span></span> Wait(ctx context.Context) (err <span class="type">error</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lim *Limiter)</span></span> WaitN(ctx context.Context, n <span class="type">int</span>) (err <span class="type">error</span>)</span><br><span class="line"><span class="comment">// WaitN 表示阻塞式获取 n 个令牌,可以传递 Context 设置超时时间</span></span><br><span class="line"><span class="comment">// Wait 即 WaitN(ctx,1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// AllowN/Allow</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lim *Limiter)</span></span> Allow() <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lim *Limiter)</span></span> AllowN(now time.Time, n <span class="type">int</span>) <span class="type">bool</span></span><br><span class="line"><span class="comment">// AllowN 表示是截止到某一时刻否能够获取到 n个令牌,满足返回 true,并消耗 n 个 Token</span></span><br><span class="line"><span class="comment">// 反之则返回 false,不消耗 Token</span></span><br><span class="line"><span class="comment">// Allow 即 AllowN(ctx,1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ReserveN/Reserve</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lim *Limiter)</span></span> Reserve() *Reservation</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lim *Limiter)</span></span> ReserveN(now time.Time, n <span class="type">int</span>) *Reservation</span><br><span class="line"><span class="comment">// ReserveN 表示截止到某一刻获取n个token,返回一个 Reservation,提供方法判断是否需要等待多少时间</span></span><br><span class="line"><span class="comment">// Reserve 相当于 ReserveN(time.Now(), 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ReserveN使用</span></span><br><span class="line"><span class="comment">// Usage example:</span></span><br><span class="line"><span class="comment">//   r := lim.ReserveN(time.Now(), 1)</span></span><br><span class="line"><span class="comment">//   if !r.OK() &#123;</span></span><br><span class="line"><span class="comment">//     // Not allowed to act! Did you remember to set lim.burst to be &gt; 0 ?</span></span><br><span class="line"><span class="comment">//     return</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">//   time.Sleep(r.Delay())</span></span><br><span class="line"><span class="comment">//   Act()</span></span><br></pre></td></tr></table></figure>

<p>三种方法的使用场景:</p>
<ul>
<li>如果不想 drop event,可以使用 Reserve,根据返回的Reservation等待一定时间后执行</li>
<li>如果需要遵守最后期限或取消延迟，使用 Wait</li>
<li>如果可以允许丢弃或者忽略超过速率的事件,使用 Allow</li>
</ul>
<h1 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h1><p>令牌桶原理图<br><img src="https://tva1.sinaimg.cn/large/00831rSTly1gdnjhiarxgj30bp06pwek.jpg"></p>
<p>看起来是有一个goroutine定时放一个队列中放入令牌,我最开始也是这样认为的,这样的好处是比较简单直观.<br>在 go 中是采用lazyload的方式实现的,通过记录最近一次消费时间跟当前时间进行对比更新Token数目,同时Token数目也不是使用队列,而是通过计数来实现,节省内存.</p>
<p>三种消费方式底层都是通过 reserveN 来实现的.<br>为什么能通过记录消费时间和计数来实现呢?主要是通过 Token 数可以和时间相互转化.通过limit可以得到以下信息:</p>
<ol>
<li>生成N个Token需要多少时间</li>
<li>在一段时间内,可以生成多少个Token</li>
</ol>
<p>根据以上两个信息和最近获取时间,当前获取时间来计算获取 n个 Token 需要等待的时间.</p>
<p>参考资料:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cyhone.com/articles/usage-of-golang-rate/">Golang 标准库限流器 time&#x2F;rate 使用介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cyhone.com/articles/analisys-of-golang-rate/">Golang 标准库限流器 time&#x2F;rate 实现剖析</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.ltinyho.top/2021/03/13/websocket-traffic-optimize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ltinyho">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ltinyho's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/13/websocket-traffic-optimize/" class="post-title-link" itemprop="url">websocket 流量优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-13 16:55:00" itemprop="dateCreated datePublished" datetime="2021-03-13T16:55:00+08:00">2021-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-09-02 09:45:09" itemprop="dateModified" datetime="2023-09-02T09:45:09+08:00">2023-09-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>做的 iot 项目,需要远程控制设备,使用 websocket 保活. 问题: sim 卡流量有限制,需要降低 sim 卡流量的消耗.</p>
<p>经过优化,流量从原来一次心跳 1k 到 一个月心跳 未优化前</p>
<h1 id="流量消耗"><a href="#流量消耗" class="headerlink" title="流量消耗"></a>流量消耗</h1><p>tcp: keep-alive websocket: ping pong go application: heart<br><img src="http://cdn.ltinyho.top/notes/websocket-no-optimize-mark.jpg" alt="网络抓包"></p>
<p>使用 wireshark 抓包后,可以很明显的看出流量的使用情况.总共分为三部分.</p>
<ol>
<li>服务端每隔 15s 给客户端发送 tcp keep-alive 包. 总共消耗 44 + 56 &#x3D; 100</li>
<li>服务端每隔 54s 给客户端发送 websocket ping 包. 总共消耗 58 + 56 + 62 + 56 &#x3D; 241</li>
<li>客户端每隔 60s 给服务端发送 websocket heart 包.总共消耗 79 + 56 &#x3D; 105 每 60s 消耗流量 (100&#x2F;15+241&#x2F;54+105&#x2F;60)*60<br>  &#x3D; 772.7 byte</li>
</ol>
<p>每个月流量 (100&#x2F;15+241&#x2F;54+105&#x2F;60)<em>60</em>60<em>24</em>30&#x2F;1024&#x2F;1024 &#x3D; 31.8 Mb</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>根据流量消耗情况,想到以下方案:</p>
<ol>
<li>调大 tcp keep-alive</li>
<li>关闭 websocket ping pong,使用客户端 heart 保活</li>
<li>客户端 heart 包间隔调长</li>
</ol>
<p>heart流量链路</p>
<p><img src="http://cdn.ltinyho.top/notes/websocket-traffic.svg" alt="流量链路"></p>
<p>client &#x3D;&gt; 负载均衡 &#x3D;&gt; k8s ingress &#x3D;&gt; 应用程序</p>
<p>方案存在的问题: <strong>在各级负载均衡中都需要配置,增加 keepalive 时间,保持长连接</strong></p>
<h1 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h1><p><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/tcp.7.html">linux 配置</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">tcp_keepalive_intvl (integer; default: 75; since Linux 2.4)</span><br><span class="line">      The number of seconds between TCP keep-alive probes.</span><br><span class="line"></span><br><span class="line">tcp_keepalive_probes (integer; default: 9; since Linux 2.2)</span><br><span class="line">      The maximum number of TCP keep-alive probes to send before</span><br><span class="line">      giving up and killing the connection if no response is</span><br><span class="line">      obtained from the other end.</span><br><span class="line"></span><br><span class="line">tcp_keepalive_time (integer; default: 7200; since Linux 2.2)</span><br><span class="line">      The number of seconds a connection needs to be idle before</span><br><span class="line">      TCP begins sending out keep-alive probes.  Keep-alives are</span><br><span class="line">      sent only when the SO_KEEPALIVE socket option is enabled.</span><br><span class="line">      The default value is 7200 seconds (2 hours).  An idle</span><br><span class="line">      connection is terminated after approximately an additional</span><br><span class="line">      11 minutes (9 probes an interval of 75 seconds apart) when</span><br><span class="line">      keep-alive is enabled.</span><br><span class="line"></span><br><span class="line">      Note that underlying connection tracking mechanisms and</span><br><span class="line">      application timeouts may be much shorter.</span><br></pre></td></tr></table></figure>

<p>linux 一般都无需配置,使用默认的即可,应用层的心跳包一般也不可能超过 2 小时.</p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#keepalive_timeout">http://nginx.org/en/docs/http/ngx_http_core_module.html#keepalive_timeout</a></p>
<p>nginx 配置:</p>
<ul>
<li>keepalive_timeout 超过多少时间没有数据,nginx 主动断开连接.</li>
<li>keepalive_requests 一个连接能发送的总请求数</li>
<li>proxy_http_version 1.1; 跟后端服务器使用的 http 版本,nginx 默认是 1.0,推荐设置为 1.1.特别是对于使用 upstream 设置 keepalive 时,更要设置为 1.1<br>版本 <a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive">官网keepalive</a></li>
<li>proxy-connect-timeout 跟后端服务器连接时间,文档上说不要超过 75 秒.为什么是 75 呢?难道是因为默认的 keepalive_timeout 为 75?待确认</li>
<li>proxy_read_timeout 如果后端服务器在这个时间之内没有发送数据,连接将被关闭.是两次成功读取的时间间隔,不是整个连接的时间.</li>
<li>proxy_write_timeout 如果nginx在这个时间之内没有发送数据给后端服务器,连接将被关闭.是两次成功写入的时间间隔,不是这个连接的时间.</li>
</ul>
<p>需要注意的是: tcp keep-alive 探测报文并不能重置 nginx 的 keepalive_timeout 超时时间,一个是 4 层的,一个是 7 层的。那为什么还有发送 keep-alive呢?防止下层设备将连接关闭掉.</p>
<p>k8s ingress 配置跟 nginx 配置基本相同.</p>
<p>设置nginx 与后端服务的长连接.<br>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">upstream cab&#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    server 192.168.10.119:8080 max_fails=3 fail_timeout=15s;</span><br><span class="line">    keepalive_timeout 8s;</span><br><span class="line">    keepalive_requests 1000;</span><br><span class="line">    keepalive 10;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://cab;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Connection &quot;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#upstream-keepalive-timeout">upstream-keepalive-timeout</a> 配置跟后端服务的长连接超时时间<br>在 nginx-configuration 配置后,无需重启 ingress-controller.</li>
</ul>
<p>添加 nginx ingress annotation</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#keep-alive">keep-alive</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/proxy-connect-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class="string">&quot;600&quot;</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class="string">&quot;600&quot;</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/keep-alive:</span> <span class="string">&quot;899&quot;</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/keep-alive-requests:</span> <span class="string">&quot;10000&quot;</span></span><br></pre></td></tr></table></figure>

<p>websocket 应用关闭服务端主动 ping,并增加在 read 数据时,设置 <code>SetWriteDeadline</code> 和 <code>SetReadDeadline</code>时间,<br>防止收到客服端 heart 时,服务端未延迟 deadline.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 去除定时器</span><br><span class="line">ticker := time.NewTicker(pingPeriod)</span><br><span class="line">defer func() &#123;</span><br><span class="line">    ticker.Stop()</span><br><span class="line">    c.conn.Close()</span><br><span class="line">&#125;()</span><br><span class="line">for &#123;</span><br><span class="line">    select &#123;</span><br><span class="line">    case &lt;-ticker.C:</span><br><span class="line">        c.conn.SetWriteDeadline(time.Now().Add(writeWait))</span><br><span class="line">        if err := c.conn.WriteMessage(websocket.PingMessage, nil); err != nil &#123;</span><br><span class="line">            log.Error(err)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h1><p>nginx 每 15 秒发送 keepalive 包 可能的原因是 docker 发送的,需要查看容器的配置 验证方法: 使用 linux 直接启动 nginx.已验证,在虚拟机中直接启动 nginx,不通过 docker 启动.同样的配置,虚拟机中不会发送 keepliave 包.</p>
<p>aliyun slb 最大超时连接时间 900s,不影响长连接时间.</p>
<p><a target="_blank" rel="noopener" href="https://ningyu1.github.io/site/post/03-nginx-502-bad-gateway/">Nginx 502 Bad Gateway问题分析与踩过的坑</a></p>
<h2 id="aws-长连接不能超过-350s"><a href="#aws-长连接不能超过-350s" class="headerlink" title="aws 长连接不能超过 350s"></a>aws 长连接不能超过 350s</h2><p>在测试过程中,一直想调长 websocket 长连接的时间,但是就是超不过 350s.超过 350 秒客户端会受到服务端的 RST 包,导致连接断开.<br>查找 aws 文档,跟 NELB 的<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/network-load-balancers.html#connection-idle-timeout">connection-idle-timeout</a><br>设置有关.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Elastic Load Balancing sets the idle timeout value for TCP flows to 350 seconds. You cannot modify this value. Clients or targets can use TCP keepalive packets to reset the idle timeout.</span><br></pre></td></tr></table></figure>
<p>NLB 设置死了 350s,不能调整.<br><img src="http://cdn.ltinyho.top/notes/20210323100438.png" alt="aws 监控"><br>aws 负载均衡 Reset 监控<br>解决措施: 将 NLB 改成4层 ELB(Classic Load Balance),调大 <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/config-idle-timeout.html#config-idle-timeout-console">connection idle timeout</a><br>相关资料:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/network-load-balancers.html#connection-idle-timeout">connection-idle-timeout</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/tenable-techblog/lessons-from-aws-nlb-timeouts-5028a8f65dda">lessons-from-aws-nlb-timeouts</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/config-idle-timeout.html#config-idle-timeout-console">ELB-idel-timeout</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.ltinyho.top/2020/12/13/network-problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ltinyho">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ltinyho's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/network-problem/" class="post-title-link" itemprop="url">centos7 网络问题排查</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-13 11:12:00" itemprop="dateCreated datePublished" datetime="2020-12-13T11:12:00+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-09-02 09:45:09" itemprop="dateModified" datetime="2023-09-02T09:45:09+08:00">2023-09-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近工作中碰到 centos7 中网络不通的问题,整理下排查网络问题的思路.</p>
<p>网络不通的情况:</p>
<ul>
<li>第一种: 不能访问公网</li>
<li>第二种: 流量不能进来</li>
</ul>
<p>第一种不能访问公网的可能的原因:</p>
<ul>
<li>物理原因<ul>
<li>网线问题<ul>
<li>没插好</li>
<li>网线质量问题</li>
</ul>
</li>
<li>交换机质量问题</li>
</ul>
</li>
<li>软件配置原因<ul>
<li>防火墙配置</li>
<li>network 配置</li>
<li>route 路由配置</li>
<li>DNS 配置问题<br>第二种 流量进不来:</li>
</ul>
</li>
<li>物理原因同上</li>
<li>软件配置原因<ul>
<li>防火墙配置</li>
<li>network 配置</li>
<li>route 路由配置</li>
</ul>
</li>
</ul>
<p>上面两种情况可能的原因很类似,但是排查的方法有不同.</p>
<p>不能访问公网的排查步骤:<br>1.首先确定是否能访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ping qq.com</span><br><span class="line">ping 8.8.8.8</span><br></pre></td></tr></table></figure>
<p>ping 8.8.8.8 有时候可能域名 ping 不通,但是 ip 地址能 ping 通,需检查 DNS 配置是否有问题<br>2. 确定 dns 是否正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看自己的 dns 配置</span></span><br><span class="line"><span class="comment"># 使用其他 dns 服务器解析</span></span><br><span class="line">dig qq.com @114.114.114.114</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看内网 ip 是否正确,路由器是否分配了 ip 或者 network 配置是否正确<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ip a</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /etc/sysconfig/network-scripts/ifcfg-eth0.conf</span><br><span class="line">```   </span><br><span class="line">4. 查看 route 配置,使用的网卡是否正确</span><br><span class="line">```bash</span><br><span class="line">route -n</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.ltinyho.top/2020/12/05/lvm-same-group-name/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ltinyho">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ltinyho's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/05/lvm-same-group-name/" class="post-title-link" itemprop="url">lvm group 重名导致 centos 启动失败</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-05 09:45:00" itemprop="dateCreated datePublished" datetime="2020-12-05T09:45:00+08:00">2020-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-09-02 09:45:09" itemprop="dateModified" datetime="2023-09-02T09:45:09+08:00">2023-09-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>使用 lvm 格式在磁盘 A 上安装 centos7 系统,使用默认的 group 名称.</p>
<p>在 磁盘 A(全部剩余空间) 和磁盘 B 上搭建 lvm mirror 模式.</p>
<p>当磁盘 A 损坏时,希望能迁移出磁盘 B 的数据.最开始想的时将磁盘 B 挂载到安装了新系统的磁盘 C,实际出现 磁盘 C 系统启动失败的问题.</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>磁盘 C 和磁盘 B 的 group 名称相同,导致系统找不到磁盘 C 的启动卷.</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>方法一： 进入急救系统，修改B 盘 vg 的名称</p>
<p>方法二： 进入系统 C，修改 C 盘 vg的名称，注意需要修改grub和 fstab 的配置<br>方案三: 重装系统 C,安装的时候使用不重名的 group 名称.</p>
<p>方法一存在的问题：</p>
<ul>
<li>使用 vgrename 不能选定 uuid 改名<ul>
<li>参考 <a target="_blank" rel="noopener" href="https://saltpepperchili.wordpress.com/2019/02/16/solved-rename-multiple-volume-groups-vgs-logical-volumes-with-the-same-name/">Rename multiple Volume Groups VGs &#x2F; Logical Volumes with the same name</a></li>
</ul>
</li>
</ul>
<p>推荐使用方案二,三,比较方便修改.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.ltinyho.top/2020/11/15/architect-ability/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ltinyho">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ltinyho's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/15/architect-ability/" class="post-title-link" itemprop="url">从程序员到架构师，从架构师到CTO (笔记)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-15 10:48:00" itemprop="dateCreated datePublished" datetime="2020-11-15T10:48:00+08:00">2020-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-09-02 09:45:09" itemprop="dateModified" datetime="2023-09-02T09:45:09+08:00">2023-09-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/69263">洪强宁：从程序员到架构师，从架构师到CTO</a></p>
<p>优秀架构师的能力：</p>
<ol>
<li><p>取舍 不同业务场景的需求和关注点不同，导致架构设计也是不同的。比如：在线直播关注时延，安全，离线业务关注吞吐率，基于不同场景做取舍。</p>
</li>
<li><p>前瞻 对未来不确定的事情提前做考虑.既有技术上的发展,也要有基于业务发展的考虑. </p>
</li>
<li><p>抽象 软件开发是复杂的,需要识别复杂度的来源,分层抽象隔离复杂度.系统全局视角,组件角色定义,不过早进入组件细节中.(写业务代码也是一样,先写伪代码,在实现细节.)</p>
</li>
<li><p>容错<br>后端开发是面向错误的开发.架构师所处的环境就更恶劣了.第一,面向错误设计,事前先做解决方案(解决方案需要事前做好演练,不能等出现问题才发现方案有问题).第二个问题是数据做好备份,没有备份的日子总是提心吊胆.第三,出现故障时如何处理?只换不修,快速切换到正常状态.</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ltinyho</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ltinyho" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ltinyho" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ltinyho</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
